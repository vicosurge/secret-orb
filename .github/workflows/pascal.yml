name: Pascal Build

on:
  push:
    branches: [ "main" ]
    paths:
      - 'pascal/**'
      - '.github/workflows/pascal.yml'
  pull_request:
    branches: [ "main" ]
    paths:
      - 'pascal/**'
  workflow_dispatch:

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Free Pascal
        run: |
          sudo apt-get update
          sudo apt-get install -y fpc

      - name: Build Linux binaries
        working-directory: pascal
        run: |
          mkdir -p bin
          fpc -O2 -XX -CX -Xs -Fusrc -obin/secretorb secretorb.pas
          fpc -O2 -XX -CX -Xs -Fusrc -obin/editor editor.pas

      - name: Package Linux build
        working-directory: pascal
        run: |
          mkdir -p dist/secretorb-linux
          cp bin/secretorb bin/editor dist/secretorb-linux/
          cp data/world.dat dist/secretorb-linux/
          tar -czf secretorb-linux-x64.tar.gz -C dist secretorb-linux

      - name: Check binary sizes
        working-directory: pascal
        run: |
          echo "=== Binary sizes ==="
          ls -lh bin/
          echo ""
          echo "=== 720KB floppy check ==="
          TOTAL=$(du -cb bin/secretorb bin/editor data/world.dat | tail -1 | cut -f1)
          echo "Total size: $TOTAL bytes"
          if [ $TOTAL -lt 737280 ]; then
            echo "PASS: Fits on 720KB floppy (737280 bytes)"
          else
            echo "WARN: Exceeds 720KB floppy capacity"
          fi

      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: secretorb-linux-x64
          path: pascal/secretorb-linux-x64.tar.gz

  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Free Pascal
        run: choco install freepascal -y

      - name: Build Windows binaries
        working-directory: pascal
        shell: cmd
        run: |
          mkdir bin
          fpc -O2 -XX -CX -Xs -Fusrc -obin\secretorb.exe secretorb.pas
          fpc -O2 -XX -CX -Xs -Fusrc -obin\editor.exe editor.pas

      - name: Package Windows build
        working-directory: pascal
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path dist\secretorb-win
          Copy-Item bin\secretorb.exe, bin\editor.exe dist\secretorb-win\
          Copy-Item data\world.dat dist\secretorb-win\
          Compress-Archive -Path dist\secretorb-win -DestinationPath secretorb-win32.zip

      - name: Check binary sizes
        working-directory: pascal
        shell: pwsh
        run: |
          Write-Host "=== Binary sizes ==="
          Get-ChildItem bin\*.exe | Format-Table Name, Length
          $total = (Get-ChildItem bin\*.exe | Measure-Object -Property Length -Sum).Sum
          $total += (Get-Item data\world.dat).Length
          Write-Host "Total size: $total bytes"
          if ($total -lt 737280) {
            Write-Host "PASS: Fits on 720KB floppy"
          } else {
            Write-Host "WARN: Exceeds 720KB floppy"
          }

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: secretorb-win32
          path: pascal/secretorb-win32.zip

  build-dos32:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Free Pascal and DOS cross-compiler
        run: |
          sudo apt-get update
          sudo apt-get install -y fpc

          # Download FPC DOS cross-compiler from official source
          FPC_VERSION="3.2.2"
          ARCH="x86_64-linux"

          # Install the go32v2 cross-compiler
          wget -q "https://sourceforge.net/projects/freepascal/files/Linux/${FPC_VERSION}/fpc-${FPC_VERSION}.${ARCH}.tar/download" -O fpc-cross.tar || true

          # If SourceForge download fails, try alternative
          if [ ! -s fpc-cross.tar ]; then
            echo "Note: DOS cross-compiler not available via package, skipping DOS build"
            echo "DOS_BUILD_SKIP=true" >> $GITHUB_ENV
          fi

      - name: Build DOS 32-bit binaries
        if: env.DOS_BUILD_SKIP != 'true'
        working-directory: pascal
        run: |
          mkdir -p bin
          fpc -Tgo32v2 -O2 -XX -CX -Xs -Fusrc -obin/SECORB.EXE secretorb.pas
          fpc -Tgo32v2 -O2 -XX -CX -Xs -Fusrc -obin/EDITOR.EXE editor.pas

      - name: Create placeholder if skipped
        if: env.DOS_BUILD_SKIP == 'true'
        working-directory: pascal
        run: |
          mkdir -p dist/SECORB
          echo "DOS build requires manual cross-compiler setup." > dist/SECORB/README.txt
          echo "Use 'fpc -Tgo32v2' with FPC cross-compiler installed." >> dist/SECORB/README.txt
          cd dist && zip -r ../secretorb-dos32.zip SECORB/

      - name: Package DOS build
        if: env.DOS_BUILD_SKIP != 'true'
        working-directory: pascal
        run: |
          mkdir -p dist/SECORB
          cp bin/SECORB.EXE bin/EDITOR.EXE dist/SECORB/
          cp data/world.dat dist/SECORB/WORLD.DAT
          cd dist && zip -r ../secretorb-dos32.zip SECORB/

      - name: Upload DOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: secretorb-dos32
          path: pascal/secretorb-dos32.zip

  release:
    needs: [build-linux, build-windows, build-dos32]
    runs-on: ubuntu-latest
    if: always() && needs.build-linux.result == 'success'
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          merge-multiple: true

      - name: List artifacts
        run: ls -lh

      - name: Upload combined release
        uses: actions/upload-artifact@v4
        with:
          name: secretorb-all-platforms
          path: |
            secretorb-*.tar.gz
            secretorb-*.zip
          retention-days: 30
