name: Pascal Build

on:
  push:
    branches: [ "main" ]
    paths:
      - 'pascal/**'
      - '.github/workflows/pascal.yml'
  pull_request:
    branches: [ "main" ]
    paths:
      - 'pascal/**'
  workflow_dispatch:

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Free Pascal
        run: |
          sudo apt-get update
          sudo apt-get install -y fpc

      - name: Build Linux binaries
        working-directory: pascal
        run: |
          mkdir -p bin
          fpc -O2 -XX -CX -Xs -Fusrc -obin/secretorb secretorb.pas
          fpc -O2 -XX -CX -Xs -Fusrc -obin/editor editor.pas

      - name: Package Linux build
        working-directory: pascal
        run: |
          mkdir -p dist/secretorb-linux
          cp bin/secretorb bin/editor dist/secretorb-linux/
          cp data/world.dat dist/secretorb-linux/
          tar -czf secretorb-linux-x64.tar.gz -C dist secretorb-linux

      - name: Check binary sizes
        working-directory: pascal
        run: |
          echo "=== Binary sizes ==="
          ls -lh bin/
          echo ""
          echo "=== 720KB floppy check ==="
          TOTAL=$(du -cb bin/secretorb bin/editor data/world.dat | tail -1 | cut -f1)
          echo "Total size: $TOTAL bytes"
          if [ $TOTAL -lt 737280 ]; then
            echo "PASS: Fits on 720KB floppy (737280 bytes)"
          else
            echo "WARN: Exceeds 720KB floppy capacity"
          fi

      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: secretorb-linux-x64
          path: pascal/secretorb-linux-x64.tar.gz

  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Free Pascal
        shell: pwsh
        run: |
          choco install freepascal -y --no-progress
          # Chocolatey installs FPC to C:\FPC\<version>\bin\<arch>
          # Add all possible bin paths
          $paths = @(
            "C:\FPC\3.2.2\bin\i386-win32",
            "C:\FPC\3.2.2\bin\x86_64-win64",
            "C:\lazarus\fpc\3.2.2\bin\i386-win32",
            "C:\lazarus\fpc\3.2.2\bin\x86_64-win64"
          )
          foreach ($p in $paths) {
            if (Test-Path $p) {
              Write-Host "Adding to PATH: $p"
              echo $p | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
            }
          }

      - name: Verify FPC installation
        shell: pwsh
        run: |
          Write-Host "PATH entries:"
          $env:PATH -split ';' | Where-Object { $_ -like '*fpc*' -or $_ -like '*FPC*' }
          Write-Host ""
          Write-Host "Checking fpc command..."
          $fpcCmd = Get-Command fpc -ErrorAction SilentlyContinue
          if ($fpcCmd) {
            Write-Host "FPC found at: $($fpcCmd.Source)"
            fpc -iV
          } else {
            Write-Host "FPC not in PATH, checking known locations..."
            $locations = @(
              "C:\FPC\3.2.2\bin\i386-win32\fpc.exe",
              "C:\FPC\3.2.2\bin\x86_64-win64\fpc.exe"
            )
            foreach ($loc in $locations) {
              if (Test-Path $loc) {
                Write-Host "Found: $loc"
                $dir = Split-Path $loc
                echo $dir | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
                break
              }
            }
          }

      - name: Build Windows binaries
        working-directory: pascal
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path bin | Out-Null
          # Use explicit path if fpc not in PATH
          $fpcExe = "fpc"
          if (-not (Get-Command fpc -ErrorAction SilentlyContinue)) {
            $fpcExe = "C:\FPC\3.2.2\bin\i386-win32\fpc.exe"
            if (-not (Test-Path $fpcExe)) {
              $fpcExe = "C:\FPC\3.2.2\bin\x86_64-win64\fpc.exe"
            }
          }
          Write-Host "Using FPC: $fpcExe"
          & $fpcExe -O2 -XX -CX -Xs -Fusrc -obin\secretorb.exe secretorb.pas
          if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }
          & $fpcExe -O2 -XX -CX -Xs -Fusrc -obin\editor.exe editor.pas
          if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }

      - name: Package Windows build
        working-directory: pascal
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path dist\secretorb-win
          Copy-Item bin\secretorb.exe, bin\editor.exe dist\secretorb-win\
          Copy-Item data\world.dat dist\secretorb-win\
          Compress-Archive -Path dist\secretorb-win -DestinationPath secretorb-win32.zip

      - name: Check binary sizes
        working-directory: pascal
        shell: pwsh
        run: |
          Write-Host "=== Binary sizes ==="
          Get-ChildItem bin\*.exe | Format-Table Name, Length
          $total = (Get-ChildItem bin\*.exe | Measure-Object -Property Length -Sum).Sum
          $total += (Get-Item data\world.dat).Length
          Write-Host "Total size: $total bytes"
          if ($total -lt 737280) {
            Write-Host "PASS: Fits on 720KB floppy"
          } else {
            Write-Host "WARN: Exceeds 720KB floppy"
          }

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: secretorb-win32
          path: pascal/secretorb-win32.zip

  build-dos32:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check for DOS cross-compiler
        id: check-dos
        run: |
          # Ubuntu's FPC package doesn't include go32v2 cross-compiler
          # We need to check if it's available
          sudo apt-get update
          sudo apt-get install -y fpc

          # Test if go32v2 target is available
          if fpc -h 2>&1 | grep -q "go32v2"; then
            echo "dos_available=true" >> $GITHUB_OUTPUT
          else
            echo "dos_available=false" >> $GITHUB_OUTPUT
            echo "Note: DOS cross-compiler (go32v2) not available in this FPC installation"
          fi

      - name: Build DOS 32-bit binaries
        if: steps.check-dos.outputs.dos_available == 'true'
        working-directory: pascal
        run: |
          mkdir -p bin
          fpc -Tgo32v2 -O2 -XX -CX -Xs -Fusrc -obin/SECORB.EXE secretorb.pas
          fpc -Tgo32v2 -O2 -XX -CX -Xs -Fusrc -obin/EDITOR.EXE editor.pas

      - name: Package DOS build
        if: steps.check-dos.outputs.dos_available == 'true'
        working-directory: pascal
        run: |
          mkdir -p dist/SECORB
          cp bin/SECORB.EXE bin/EDITOR.EXE dist/SECORB/
          cp data/world.dat dist/SECORB/WORLD.DAT
          cd dist && zip -r ../secretorb-dos32.zip SECORB/

      - name: Create placeholder (DOS unavailable)
        if: steps.check-dos.outputs.dos_available != 'true'
        working-directory: pascal
        run: |
          mkdir -p dist/SECORB
          cat > dist/SECORB/README.txt << 'ENDREADME'
          DOS Build Not Available
          ========================
          The go32v2 (DOS 32-bit DPMI) cross-compiler is not available
          in GitHub Actions' Ubuntu runner.

          To build DOS executables locally:
          1. Install FPC with go32v2 cross-compiler support
          2. Run: fpc -Tgo32v2 -O2 secretorb.pas
          3. Run: fpc -Tgo32v2 -O2 editor.pas

          The resulting .EXE files will run on DOS with CWSDPMI.
          ENDREADME
          cd dist && zip -r ../secretorb-dos32.zip SECORB/

      - name: Upload DOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: secretorb-dos32
          path: pascal/secretorb-dos32.zip

  release:
    needs: [build-linux, build-windows, build-dos32]
    runs-on: ubuntu-latest
    if: always() && needs.build-linux.result == 'success'
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          merge-multiple: true

      - name: List artifacts
        run: ls -lh

      - name: Upload combined release
        uses: actions/upload-artifact@v4
        with:
          name: secretorb-all-platforms
          path: |
            secretorb-*.tar.gz
            secretorb-*.zip
          retention-days: 30
