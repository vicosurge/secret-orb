name: Pascal Build

on:
  push:
    branches: [ "main" ]
    paths:
      - 'pascal/**'
      - '.github/workflows/pascal.yml'
  pull_request:
    branches: [ "main" ]
    paths:
      - 'pascal/**'
  workflow_dispatch:

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Free Pascal
        run: |
          sudo apt-get update
          sudo apt-get install -y fpc

      - name: Build Linux binaries
        working-directory: pascal
        run: |
          mkdir -p bin
          fpc -O2 -XX -CX -Xs -Fusrc -obin/secretorb secretorb.pas
          fpc -O2 -XX -CX -Xs -Fusrc -obin/editor editor.pas
          echo "Building Turbo Vision editor (verification only)..."
          fpc -O2 -XX -CX -Xs -Fusrc -obin/editor-tv editor-tv.pas

      - name: Package Linux build
        working-directory: pascal
        run: |
          mkdir -p dist/secretorb-linux
          cp bin/secretorb bin/editor dist/secretorb-linux/
          cp data/world.dat dist/secretorb-linux/
          tar -czf secretorb-linux-x64.tar.gz -C dist secretorb-linux

      - name: Check binary sizes
        working-directory: pascal
        run: |
          echo "=== Binary sizes ==="
          ls -lh bin/
          echo ""
          echo "=== 720KB floppy check ==="
          TOTAL=$(du -cb bin/secretorb bin/editor data/world.dat | tail -1 | cut -f1)
          echo "Total size: $TOTAL bytes"
          if [ $TOTAL -lt 737280 ]; then
            echo "PASS: Fits on 720KB floppy (737280 bytes)"
          else
            echo "WARN: Exceeds 720KB floppy capacity"
          fi

      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: secretorb-linux-x64
          path: pascal/secretorb-linux-x64.tar.gz

  build-windows:
    runs-on: windows-latest
    env:
      FPC_VERSION: "3.2.2"
      FPC_DIR: "C:\\fpc"
    steps:
      - uses: actions/checkout@v4

      - name: Install Free Pascal
        shell: pwsh
        run: |
          # Use the installer from the repository
          $installer = "fpc-${{ env.FPC_VERSION }}.i386-win32.exe"

          Write-Host "Running FPC installer in silent mode..."
          Write-Host "Installer: $installer"

          # Run installer silently, install to C:\fpc
          Start-Process -FilePath $installer -ArgumentList "/VERYSILENT", "/SUPPRESSMSGBOXES", "/DIR=${{ env.FPC_DIR }}", "/NORESTART" -Wait -NoNewWindow

          Write-Host "Installation complete. Contents of ${{ env.FPC_DIR }}:"
          Get-ChildItem -Path ${{ env.FPC_DIR }} -Depth 1 | Select-Object Name

      - name: Verify FPC installation
        shell: pwsh
        run: |
          Write-Host "Looking for fpc.exe in ${{ env.FPC_DIR }}..."

          # Check expected location first
          $expectedPath = "${{ env.FPC_DIR }}\bin\i386-win32\fpc.exe"
          if (Test-Path $expectedPath) {
            Write-Host "Found at expected location: $expectedPath"
            & $expectedPath -iV
            "${{ env.FPC_DIR }}\bin\i386-win32" | Out-File -FilePath fpc_path.txt -Encoding utf8
          } else {
            # Search for it
            $fpc = Get-ChildItem -Path ${{ env.FPC_DIR }} -Recurse -Filter "fpc.exe" -ErrorAction SilentlyContinue | Select-Object -First 1
            if ($fpc) {
              Write-Host "Found: $($fpc.FullName)"
              & $fpc.FullName -iV
              $fpc.DirectoryName | Out-File -FilePath fpc_path.txt -Encoding utf8
            } else {
              Write-Host "ERROR: fpc.exe not found!"
              Write-Host "Directory contents:"
              Get-ChildItem -Path ${{ env.FPC_DIR }} -Recurse | Select-Object FullName
              exit 1
            }
          }

      - name: Build Windows binaries
        working-directory: pascal
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path bin | Out-Null

          # Use FPC from known install location
          $fpcExe = "${{ env.FPC_DIR }}\bin\i386-win32\fpc.exe"

          Write-Host "Using FPC: $fpcExe"
          Write-Host "FPC exists: $(Test-Path $fpcExe)"

          if (-not (Test-Path $fpcExe)) {
            Write-Host "ERROR: FPC not found at expected path"
            Write-Host "Searching for fpc.exe..."
            Get-ChildItem -Path ${{ env.FPC_DIR }} -Recurse -Filter "fpc.exe" | Select-Object FullName
            exit 1
          }

          Write-Host "Compiling secretorb.pas..."
          & $fpcExe -O2 -XX -CX -Xs -Fusrc -obin\secretorb.exe secretorb.pas
          $exitCode1 = $LASTEXITCODE
          Write-Host "Exit code: $exitCode1"

          Write-Host "Compiling editor.pas..."
          & $fpcExe -O2 -XX -CX -Xs -Fusrc -obin\editor.exe editor.pas
          $exitCode2 = $LASTEXITCODE
          Write-Host "Exit code: $exitCode2"

          Write-Host "Compiling editor-tv.pas (verification only)..."
          & $fpcExe -O2 -XX -CX -Xs -Fusrc -obin\editor-tv.exe editor-tv.pas
          $exitCode3 = $LASTEXITCODE
          Write-Host "Exit code: $exitCode3"

          Write-Host "Contents of bin directory:"
          Get-ChildItem -Path bin -ErrorAction SilentlyContinue | Select-Object Name, Length

          if ($exitCode1 -ne 0) { exit $exitCode1 }
          if ($exitCode2 -ne 0) { exit $exitCode2 }
          if ($exitCode3 -ne 0) { exit $exitCode3 }

      - name: Package Windows build
        working-directory: pascal
        shell: pwsh
        run: |
          Write-Host "Checking bin directory..."
          Get-ChildItem -Path bin -ErrorAction SilentlyContinue

          # FPC creates files without .exe extension, rename them
          # Use Move-Item instead of Rename-Item to avoid PowerShell path issues
          if (Test-Path bin\secretorb) {
            Move-Item -Path bin\secretorb -Destination bin\secretorb.exe -Force
          }
          if (Test-Path bin\editor) {
            Move-Item -Path bin\editor -Destination bin\editor.exe -Force
          }

          if (-not (Test-Path bin\secretorb.exe)) {
            Write-Host "ERROR: secretorb.exe not found after rename!"
            exit 1
          }

          New-Item -ItemType Directory -Force -Path dist\secretorb-win | Out-Null
          Copy-Item bin\secretorb.exe dist\secretorb-win\
          Copy-Item bin\editor.exe dist\secretorb-win\
          Copy-Item data\world.dat dist\secretorb-win\
          Compress-Archive -Path dist\secretorb-win -DestinationPath secretorb-win32.zip

      - name: Check binary sizes
        working-directory: pascal
        shell: pwsh
        run: |
          Write-Host "=== Binary sizes ==="
          Get-ChildItem bin\*.exe | Format-Table Name, Length
          $total = (Get-ChildItem bin\*.exe | Measure-Object -Property Length -Sum).Sum
          $total += (Get-Item data\world.dat).Length
          Write-Host "Total size: $total bytes"
          if ($total -lt 737280) {
            Write-Host "PASS: Fits on 720KB floppy"
          } else {
            Write-Host "WARN: Exceeds 720KB floppy"
          }

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: secretorb-win32
          path: pascal/secretorb-win32.zip

  build-dos32:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check for DOS cross-compiler
        id: check-dos
        run: |
          # Ubuntu's FPC package doesn't include go32v2 cross-compiler
          # We need to check if it's available
          sudo apt-get update
          sudo apt-get install -y fpc

          # Test if go32v2 target is available
          if fpc -h 2>&1 | grep -q "go32v2"; then
            echo "dos_available=true" >> $GITHUB_OUTPUT
          else
            echo "dos_available=false" >> $GITHUB_OUTPUT
            echo "Note: DOS cross-compiler (go32v2) not available in this FPC installation"
          fi

      - name: Build DOS 32-bit binaries
        if: steps.check-dos.outputs.dos_available == 'true'
        working-directory: pascal
        run: |
          mkdir -p bin
          fpc -Tgo32v2 -O2 -XX -CX -Xs -Fusrc -obin/SECORB.EXE secretorb.pas
          fpc -Tgo32v2 -O2 -XX -CX -Xs -Fusrc -obin/EDITOR.EXE editor.pas

      - name: Package DOS build
        if: steps.check-dos.outputs.dos_available == 'true'
        working-directory: pascal
        run: |
          mkdir -p dist/SECORB
          cp bin/SECORB.EXE bin/EDITOR.EXE dist/SECORB/
          cp data/world.dat dist/SECORB/WORLD.DAT
          cd dist && zip -r ../secretorb-dos32.zip SECORB/

      - name: Create placeholder (DOS unavailable)
        if: steps.check-dos.outputs.dos_available != 'true'
        working-directory: pascal
        run: |
          mkdir -p dist/SECORB
          cat > dist/SECORB/README.txt << 'ENDREADME'
          DOS Build Not Available
          ========================
          The go32v2 (DOS 32-bit DPMI) cross-compiler is not available
          in GitHub Actions' Ubuntu runner.

          To build DOS executables locally:
          1. Install FPC with go32v2 cross-compiler support
          2. Run: fpc -Tgo32v2 -O2 secretorb.pas
          3. Run: fpc -Tgo32v2 -O2 editor.pas

          The resulting .EXE files will run on DOS with CWSDPMI.
          ENDREADME
          cd dist && zip -r ../secretorb-dos32.zip SECORB/

      - name: Upload DOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: secretorb-dos32
          path: pascal/secretorb-dos32.zip

  release:
    needs: [build-linux, build-windows, build-dos32]
    runs-on: ubuntu-latest
    if: always() && needs.build-linux.result == 'success'
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          merge-multiple: true

      - name: List artifacts
        run: ls -lh

      - name: Upload combined release
        uses: actions/upload-artifact@v4
        with:
          name: secretorb-all-platforms
          path: |
            secretorb-*.tar.gz
            secretorb-*.zip
          retention-days: 30
